<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FriendManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;CloudBookClient&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">model.friendmanager</a> &gt; <span class="el_source">FriendManager.java</span></div><h1>FriendManager.java</h1><pre class="source lang-java linenums">package model.friendmanager;

import static java.lang.Math.pow;
import static java.lang.Math.sqrt;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;
import model.node.AppVector;
import model.node.Cloud;
import model.node.MyNode;
import model.node.InformationBox;
import model.node.friend.Friend;
import model.node.friend.Member;

public class FriendManager implements IFriendManager {
    
    protected static final double seuil = 30; //Distance en dessous de laquelle une noeud est considéré comme pertinent (valeure choisie arbitrairement, à modifier)
    protected static final int delay = 10; //Délai en jours après lequel on enlève un noeud de la liste d'amis si on a pas eu d'échange avec lui pendant cette période (valeure choisie arbitrairement, à modifier)
    
    protected MyNode node;
    
    /**
     * Constructor
     */
<span class="nc" id="L27">    public FriendManager() {</span>
<span class="nc" id="L28">        node = new MyNode();</span>
<span class="nc" id="L29">    }</span>
    
    /**
     * Constructor
     * @param node current application
     */
<span class="fc" id="L35">    public FriendManager(MyNode node) {</span>
<span class="fc" id="L36">        this.node = node;</span>
<span class="fc" id="L37">    }</span>

    @Override
    public boolean add(Member sender) {
<span class="nc" id="L41">        AppVector vector = sender.getVector();</span>
<span class="nc" id="L42">        String id = sender.getId();</span>
<span class="nc" id="L43">        Cloud cloud = sender.getCloud();</span>
<span class="nc bnc" id="L44" title="All 4 branches missed.">        if(!isFriend(id) &amp;&amp; relevant(vector)) {</span>
<span class="nc" id="L45">            Friend friend = new Friend(id, 0, relevance(vector), vector, cloud);</span>
<span class="nc" id="L46">            node.addFriend(friend); //indice de confiance initialiser à 0 lors de l'ajout d'un nouvel ami</span>
<span class="nc" id="L47">            return true;</span>
        }
<span class="nc" id="L49">        return false;</span>
    }
    
    @Override
    public void clear() {
<span class="nc" id="L54">        InformationBox&lt;Friend&gt; friends = node.getFriends();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        for(Friend friend : friends) {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">            if(friend.daysSinceLastConnection() &gt; delay)</span>
<span class="nc" id="L57">                remove(friend.idProperty().get());</span>
<span class="nc" id="L58">        }   </span>
<span class="nc" id="L59">    }</span>

    @Override
    public boolean isFriend(String id) {
<span class="nc" id="L63">        InformationBox&lt;Friend&gt; friends = node.getFriends();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        for(Friend friend : friends) </span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if(friend.getId().equals(id))</span>
<span class="nc" id="L66">                return true;</span>
<span class="nc" id="L67">        return false;</span>
    }

    @Override
    public double relevance(AppVector v) {
<span class="nc" id="L72">        AppVector vector = node.getVector();</span>
<span class="nc" id="L73">        double xa = vector.getAppType(); </span>
<span class="nc" id="L74">        double ya = vector.getPerformanceNeed();</span>
<span class="nc" id="L75">        double za = vector.getSpeedNeed(); </span>
<span class="nc" id="L76">        double xb = v.getAppType(); </span>
<span class="nc" id="L77">        double yb = v.getPerformanceNeed(); </span>
<span class="nc" id="L78">        double zb = v.getSpeedNeed(); </span>
<span class="nc" id="L79">        double dist = sqrt(pow(xb-xa, 2)+pow(yb-ya, 2)+pow(zb-za, 2));</span>
<span class="nc" id="L80">        return dist;</span>
    }
    
    @Override
    public boolean relevant(AppVector v) {
        //System.out.println(&quot;(Vector, seuil) = &quot; + relevance(v) + &quot; &quot; + seuil);
<span class="nc bnc" id="L86" title="All 2 branches missed.">        return relevance(v) &lt; seuil;</span>
    }

    @Override
    public void remove(String id) {
<span class="nc" id="L91">        InformationBox&lt;Friend&gt; friends = node.getFriends();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        for(int i = 0; i &lt; friends.size(); i++) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if(friends.get(i).getId().equals(id)) {</span>
<span class="nc" id="L94">                friends.remove(friends.get(i));</span>
<span class="nc" id="L95">                break;</span>
            }  
        }
<span class="nc" id="L98">    }</span>

    @Override
    public void update(Member sender) {
        //On tente d'ajouter le sender à la liste d'amis
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if(add(sender))</span>
<span class="nc" id="L104">            return;</span>
        /*
        Si l'ajout échoue, soit le sender n'est pas pertinent, soit il est déja dans la liste des amis
        On parcours donc la liste des amis et si on l'y trouve on vérifie s'il est toujours pertinent
        si oui, on met à jour son vecteur sinon on le supprime de la liste d'amis
        */
<span class="nc" id="L110">        InformationBox&lt;Friend&gt; friends = node.getFriends();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        for(Friend friend : friends) {</span>
<span class="nc" id="L112">            String id = sender.getId();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if(friend.getId().equals(id)) {</span>
<span class="nc" id="L114">                AppVector vector = sender.getVector();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if(relevant(vector)) {</span>
<span class="nc" id="L116">                    friend.setVector(vector);</span>
<span class="nc" id="L117">                    friend.relevanceProperty().set(relevance(vector));</span>
                } else
<span class="nc" id="L119">                    remove(id);</span>
<span class="nc" id="L120">                break;</span>
            }  
<span class="nc" id="L122">        }</span>
<span class="nc" id="L123">    }</span>
    
    @Override
    public List&lt;Friend&gt; getRelevantFriends(int nb) {
<span class="nc" id="L127">        InformationBox&lt;Friend&gt; allFriends = node.getFriends();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if(allFriends.size() &lt;= nb)</span>
<span class="nc" id="L129">            return allFriends.boxObservableList();</span>
<span class="nc" id="L130">        List&lt;Friend&gt; friends = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L131">        sortByRelevance(allFriends.boxObservableList(), 0, allFriends.size()-1);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        for(int i = 0; i&lt;nb; i++) {</span>
<span class="nc" id="L133">            friends.add(allFriends.get(i));</span>
        }
<span class="nc" id="L135">        return friends;</span>
    }
    
    @Override
    public List&lt;Friend&gt; getTrustedFriends(int nb) {
<span class="nc" id="L140">        List&lt;Friend&gt; allFriends = node.getFriends().boxObservableList();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if(allFriends.size() &lt;= nb)</span>
<span class="nc" id="L142">            return allFriends;</span>
<span class="nc" id="L143">        List&lt;Friend&gt; friends = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L144">        sortByConfidence(allFriends, 0, allFriends.size()-1);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        for(int i = 0; i&lt;nb; i++) {</span>
<span class="nc" id="L146">            friends.add(allFriends.get(i));</span>
        }
<span class="nc" id="L148">        return friends;</span>
    }
    
    @Override
    public List&lt;Friend&gt; getSomeFriends(int nb) {
<span class="nc" id="L153">        List&lt;Friend&gt; allFriends = node.getFriends().boxObservableList();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if(allFriends.size() &lt;= nb)</span>
<span class="nc" id="L155">            return allFriends;</span>
<span class="nc" id="L156">        List&lt;Friend&gt; friends = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (Friend f : allFriends) {</span>
<span class="nc" id="L158">            friends.add(f);</span>
<span class="nc" id="L159">        }</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for(int i = 0; i&lt;friends.size()-nb; i++) {</span>
<span class="nc" id="L161">            Random rand = new Random();</span>
<span class="nc" id="L162">            int j = rand.nextInt(friends.size());</span>
<span class="nc" id="L163">            friends.remove(j);</span>
        }
<span class="nc" id="L165">        return friends;</span>
    }
    
    /**
     * Methode permettant de trier un liste d'amis par ordre de pertinence (les plus pertinent au début)
     * @param friends   liste d'amis à trier
     * @param left      rang à partir duquel le tri doit être fait
     * @param right     rang juqu'auquel le tri doit être fait
     */
    private void sortByRelevance(List&lt;Friend&gt; friends, int left, int right) {
        //algorithme quicksort
<span class="nc" id="L176">        int i = left, j = right;</span>
        Friend tmp;
<span class="nc" id="L178">        Friend pivot = friends.get(left+(right-left)/2);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        while(i &lt;= j) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            while(friends.get(i).relevanceProperty().get() &lt; pivot.relevanceProperty().get())</span>
<span class="nc" id="L181">                i++;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            while(friends.get(j).relevanceProperty().get() &gt; pivot.relevanceProperty().get())</span>
<span class="nc" id="L183">                j--;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (i &lt;= j) {</span>
<span class="nc" id="L185">                tmp = friends.get(i);</span>
<span class="nc" id="L186">                friends.set(i, friends.get(j));</span>
<span class="nc" id="L187">                friends.set(j, tmp);</span>
<span class="nc" id="L188">                i++;</span>
<span class="nc" id="L189">                j--;</span>
            }
        }
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (left &lt; j)</span>
<span class="nc" id="L193">            sortByRelevance(friends, left, j);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (i &lt; right)</span>
<span class="nc" id="L195">            sortByRelevance(friends, i, right);</span>
<span class="nc" id="L196">    }</span>
    
    /**
     * Methode permettant de trier un liste d'amis par ordre de confiance (ceux à qui on fait le plus confiance au début)
     * @param friends   liste d'amis à trier
     * @param left      rang à partir duquel le tri doit être fait
     * @param right     rang juqu'auquel le tri doit être fait
     */
    private void sortByConfidence(List&lt;Friend&gt; friends, int left, int right) {
        //algorithme quicksort
<span class="nc" id="L206">        int i = left, j = right;</span>
        Friend tmp;
<span class="nc" id="L208">        Friend pivot = friends.get(left+(right-left)/2);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        while(i &lt;= j) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            while(friends.get(i).confidenceProperty().get() &gt; pivot.confidenceProperty().get())</span>
<span class="nc" id="L211">                i++;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            while(friends.get(j).confidenceProperty().get() &lt; pivot.confidenceProperty().get())</span>
<span class="nc" id="L213">                j--;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (i &lt;= j) {</span>
<span class="nc" id="L215">                tmp = friends.get(i);</span>
<span class="nc" id="L216">                friends.set(i, friends.get(j));</span>
<span class="nc" id="L217">                friends.set(j, tmp);</span>
<span class="nc" id="L218">                i++;</span>
<span class="nc" id="L219">                j--;</span>
            }
        }
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (left &lt; j)</span>
<span class="nc" id="L223">            sortByConfidence(friends, left, j);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (i &lt; right)</span>
<span class="nc" id="L225">            sortByConfidence(friends, i, right);</span>
<span class="nc" id="L226">    }</span>
    
    /**
     * Finds out the best rated cloud for this application
     * @return the best rated cloud for this application
     */
    @Override
    public Cloud bestCloud() {
<span class="nc" id="L234">        Map&lt;Cloud, Double&gt; scoreTable = scores();</span>
<span class="nc" id="L235">        Cloud res = null;</span>
<span class="nc" id="L236">        double max = 0.0;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        for(Cloud c : scoreTable.keySet()) {</span>
<span class="nc" id="L238">            double d = scoreTable.get(c);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if(d &gt; max) {</span>
<span class="nc" id="L240">                max = d;</span>
<span class="nc" id="L241">                res = c;</span>
            }
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">        return res;</span>
    }
    
    /**
     * Computes the relavance sum for each existing cloud
     * @return an association table containing all the scores
     */
    @Override
    public Map&lt;Cloud, Double&gt; scores() {
<span class="nc" id="L253">        Map&lt;Cloud, Double&gt; res = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        for(Cloud c : Cloud.values()) {</span>
<span class="nc" id="L255">            double score = relevanceSum(c);</span>
<span class="nc" id="L256">            res.put(c, score);</span>
        }
<span class="nc" id="L258">        return res;</span>
    }
    
    /**
     * Computes the relevance sum over the friend list of friends who are on the specified cloud
     * @param cloud cloud we look for to increment relevance
     * @return the relevance sum over the friend list for the specified cloud
     */
    @Override
    public double relevanceSum(Cloud cloud) {
<span class="nc" id="L268">        InformationBox&lt;Friend&gt; friends = node.getFriends();</span>
<span class="nc" id="L269">        double res = 0.0;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        for(Friend f : friends) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if(f.cloudProperty().get() == cloud)</span>
<span class="nc" id="L272">                res += f.relevanceProperty().get();</span>
<span class="nc" id="L273">        }</span>
<span class="nc" id="L274">        return res;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>